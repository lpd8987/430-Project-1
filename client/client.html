<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="clientStyle.css">
    <title>Appunti Italiani API</title>

    <script>
        const handleResponse = async (response) => {
            
            //Only time that something is not returned is when updated
            if(response.status === 204){
                document.querySelector("#message").innerHTML = "<h2>Updated Successfully</h2>";
                return;
            }

            let jsonResponse = await response.json();

            console.log(jsonResponse);

            //Print a message if not printing a list
            if(jsonResponse.message){
                document.querySelector("#message").innerHTML = `<h2>${jsonResponse.message}</h2>`;
                return;
            }

            //for vocab list, will only get here if the user has not added any data.
            if(jsonResponse.length < 1){
                document.querySelector("#message").innerHTML = "<h2>List is currently empty.</h2>"
                return;
            }

            //Print out the entire list if there is one to print
            for(let i = 0; i < jsonResponse.length; i++){
                createDiv(jsonResponse[i].word, jsonResponse[i].type, jsonResponse[i].definition, document.querySelector("#content"));
            }
        }

        //POST REQUESTS
        const formPostRequest = async(form) => {
            clearDivs(document.querySelector("#content"));

            const action = form.getAttribute("action");
            const method = form.getAttribute("method");

            const wordInput = form.querySelector("#word-field");
            const typeInput = form.querySelector("#type-select");
            const defInput = form.querySelector("#definition-field");

            const params = `word=${wordInput.value}&type=${typeInput.value}&definition=${defInput.value}`;

            let response = await fetch(action, {
                method: method,
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Accept": "application/json"
                },
                body: params
            })

            handleResponse(response);
        };

        const buttonPostRequest = async(word, type, definition) => {
            const params = `word=${word}&type=${type}&definition=${definition}`;

            let response = await fetch("/addVocab", {
                method: 'POST',
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Accept": "application/json"
                },
                body: params
            })

            handleResponse(response);
        };

        //GET REQUESTS
        const fetchRequest = async(button) => {
            clearDivs(document.querySelector("#content"));
            const url = button.value;
            let response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                },
            });

            handleResponse(response);
        };

        const fetchRequestWithParams = async(form) => {
            clearDivs(document.querySelector("#content"));

            const action = form.getAttribute("action");
            const method = form.getAttribute("method");

            const query = form.querySelector("#query-field");
            const type = form.querySelector("#type-select");

            const params = `query=${query}&type=${type}`;

            let response = await fetch(action, {
                method: method,
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Accept": "application/json"
                },
                body: params
            })

            handleResponse(response);
        };

        //Creates the divs that the content comes from
        function createDiv(word, type, definition, targetElement)
        {
            let typeAbbrev = "";
            switch(type){
                case "verb":
                    typeAbbrev = "(v.)"
                    break;
                case "noun":
                    typeAbbrev = "(n.)"
                    break;
                case "adjective":
                    typeAbbrev = "(adj.)" 
                    break;
                case "adverb":
                    typeAbbrev = "(adv.)" 
                    break;
            }

            /*Format should look something like:
            Word (part-of-speech)
            definition
            [addBtn] [removeBtn]*/

            let newDiv = document.createElement("div");
            newDiv.classList.add("data-entry");
            
            let divTitle = document.createElement("h2");
            divTitle.innerHTML = `${word} ${typeAbbrev}`;
            newDiv.appendChild(divTitle);

            let divContent = document.createElement("p");
            divContent.innerHTML = definition;
            newDiv.appendChild(divContent);

            //Button to add to vocab list
            let addBtn = document.createElement("button");
            addBtn.innerHTML = "Add to Vocab List";
            addBtn.addEventListener("click", () => {buttonPostRequest(word, type, definition)});
            newDiv.appendChild(addBtn);

            addBtn.addEventListener("click", () => {
                addBtn.innerHTML = "Added!"
                addBtn.style.backgroundColor = "green";
                addBtn.disabled = true;
            });

            targetElement.appendChild(newDiv);
        }


        //Clears all custom divs from the screen
        function clearDivs(targetElement) {
            let divs = document.querySelectorAll(".data-entry");
            if(divs.length > 0){
                for(let i = divs.length-1; i > -1; i--){
                    targetElement.removeChild(targetElement.children[i]);
                }
            }
        }

        
        const init = () => {
            //Setup buttons and event listeners
            const getVerbsBtn = document.querySelector("#get-verbs");
            getVerbsBtn.addEventListener("click", () => {fetchRequest(getVerbsBtn)});

            const getNounsBtn = document.querySelector("#get-nouns");
            getNounsBtn.addEventListener("click", () => {fetchRequest(getNounsBtn)});

            const getAdjectivesBtn = document.querySelector("#get-adjectives");
            getAdjectivesBtn.addEventListener("click", () => {fetchRequest(getAdjectivesBtn)});

            const getAdverbsBtn = document.querySelector("#get-adverbs");
            getAdverbsBtn.addEventListener("click", () => {fetchRequest(getAdverbsBtn)});

            const getVocabBtn = document.querySelector("#get-vocab-list");
            getVocabBtn.addEventListener("click", () => {fetchRequest(getVocabBtn)});

            //Setup custom form
            const vocabForm = document.querySelector("#post-vocab");
            const postVocab = (e) => {
                e.preventDefault();
                formPostRequest(vocabForm);
                return;
            }

            const searchForm = document.querySelector("#search-vocab")
            const searchVocab = (e) => {
                e.preventDefault();
                fetchRequestWithParams(searchForm);
            }


            vocabForm.addEventListener("submit", postVocab);
            searchForm.addEventListener("submit", searchVocab);
        };

        window.onload = init;
    </script>
</head>
<body>
    <h1>Appunti Italiani</h1>
    <!--Buttons-->
    <div>
        <button id="get-verbs" value="/verbs">GET Verbs</button>
        <button id="get-nouns" value="/nouns">GET Nouns</button>
        <button id="get-adjectives" value="/adjectives">GET Adjectives</button>
        <button id="get-adverbs" value="/adverbs">GET Adverbs</button>
        <button id="get-vocab-list" value="/vocabulary">GET Vocab List</button>
    </div>

    <h2 id="message"></h2>

    <!--Add Vocab-->
    <form id="post-vocab" action="/addVocab" method="post">
        <label for="word">Word: </label>
        <input id="word-field" type="text" name="word">

        <label for="type">Type: </label>
        <select name="type" id="type-select">
            <option value="verb">Verb</option>
            <option value="noun">Noun</option>
            <option value="adjective">Adjective</option>
            <option value="adverb">Adverb</option>
        </select>

        <label for="definition">Definition: </label>
        <input id="definition-field" type="text" name="definition">

        <input type="submit" value="Add Vocab">
    </form>

    <!--Search Vocab-->
    <form id="search-vocab" action="/search" method="get">
        <label for="query">Search: </label>
        <input id="query-field" type="text" name="query">

        <label for="type">Type: </label>
        <select name="type" id="type-select">
            <option value="word">By Word</option>
            <option value="definition">By Definition</option>
        </select>

        <input type="submit" value="submit">
    </form>

    <!--Page Content-->
    <div id="content">

    </div>
</body>
</html>